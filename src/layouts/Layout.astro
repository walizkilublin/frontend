---
// Import globalnych styli Tailwind v4 (zawiera nasz grain overlay i kolory)
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
import fetchApi from '../lib/strapi';

// IMPORT BANERA CIASTECZEK ORAZ PRELOADERA
import CookieConsent from '../components/CookieConsent.svelte';
import Preloader from '../components/Preloader.svelte';

interface Props {
    title?: string;
    description?: string;
    image?: string;
}

const { title, description, image } = Astro.props;

// Zmienne środowiskowe i GTM
const GTM_ID = import.meta.env.PUBLIC_GTM_ID || ''; 
const PUBLIC_STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337';
const nonce = ''; // Obsługiwane przez Netlify Edge Functions

// Pobieramy Global Settings i SEO ze Strapi v5
let globalSettings = null;
try {
    globalSettings = await fetchApi<any>({
        endpoint: 'global-setting',
        query: {
            populate: {
                seo: {
                    // W Strapi najbezpieczniej głęboko populować komponenty i media używając notacji tablicowej z kropkami:
                    populate: ['metaImage', 'openGraph.ogImage']
                },
            },
        },
    });
} catch (error) {
    console.error('⚠️ [SEO] Nie udało się pobrać Global Settings ze Strapi:', error);
}

const globalSeo = globalSettings?.data?.seo || {};

// Helper do obsługi ścieżek obrazków ze Strapi (zarówno absolutnych, jak i relatywnych)
const getImageUrl = (url?: string) => {
    if (!url) return undefined;
    if (url.startsWith('http')) return url;
    return `${PUBLIC_STRAPI_URL}${url}`;
};

// 1. Podstawowe Meta Tagi (Props > Global SEO > Fallback)
const finalTitle = title || globalSeo?.metaTitle || 'WALIZKI LUBLIN | Hurtownia Bagażu';
const finalDescription = description || globalSeo?.metaDescription || 'Zaopatrujemy liderów rynku detalicznego.';
const finalImage = getImageUrl(image || globalSeo?.metaImage?.url) || '/default-og.jpg';
const metaViewport = globalSeo?.metaViewport || 'width=device-width, initial-scale=1.0';
const metaRobots = globalSeo?.metaRobots || 'index, follow';
const keywords = globalSeo?.keywords;
const canonicalURL = globalSeo?.canonicalURL || Astro.url.href; // Domyślnie obecny, dokładny URL
const structuredData = globalSeo?.structuredData;

// 2. Tagi Open Graph (Komponent OG ze Strapi > Fallback na Podstawowe Meta Tagi)
const ogTitle = globalSeo?.openGraph?.ogTitle || finalTitle;
const ogDescription = globalSeo?.openGraph?.ogDescription || finalDescription;
const ogImage = getImageUrl(globalSeo?.openGraph?.ogImage?.url) || finalImage;
const ogUrl = globalSeo?.openGraph?.ogUrl || Astro.url.href;
const ogType = globalSeo?.openGraph?.ogType || 'website';
---

<!doctype html>
<html lang="pl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content={metaViewport} />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        
        {/* ===== BAZOWE SEO ===== */}
        <title>{finalTitle}</title>
        <meta name="description" content={finalDescription} />
        <link rel="canonical" href={canonicalURL} />
        <meta name="robots" content={metaRobots} />
        {keywords && <meta name="keywords" content={keywords} />}
        
        {/* ===== OPEN GRAPH ===== */}
        <meta property="og:title" content={ogTitle} />
        <meta property="og:description" content={ogDescription} />
        <meta property="og:image" content={ogImage} />
        <meta property="og:url" content={ogUrl} />
        <meta property="og:type" content={ogType} />

        {/* ===== STRUCTURED DATA (JSON-LD) ===== */}
        {structuredData && (
            <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
        )}
        
        {/* ===== CZCIONKI ===== */}
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;800;900&display=swap" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;800;900&display=swap" media="print" onload="this.media='all'" />
        <noscript>
            <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;800;900&display=swap" />
        </noscript>

        <ClientRouter />


		{/* --- INTELIGENTNY SCROLL --- */}
        {/* Wyłącza smooth-scroll na czas przechodzenia między podstronami, żeby nie było efektu zjeżdżania przy zamykaniu popupu */}
        <script is:inline>
            document.addEventListener('astro:before-preparation', () => {
                document.documentElement.style.scrollBehavior = 'auto';
            });
            document.addEventListener('astro:page-load', () => {
                setTimeout(() => {
                    document.documentElement.style.scrollBehavior = 'smooth';
                }, 10); // Przywraca płynność tuż po natychmiastowym przeskoku
            });
        </script>
		
        {/* ===== GTM: Twój autorski, zoptymalizowany loader Consent Mode v2 ===== */}
        {GTM_ID && (
          <script is:inline nonce={nonce} define:vars={{ GTM_ID, nonce }}>
            (function () {
              // 1) dataLayer + stub gtag — MUSI powstać przed GTM
              window.dataLayer = window.dataLayer || [];
              window.gtag = window.gtag || function(){ window.dataLayer.push(arguments); };

              // 2) Consent Mode v2 — default DENIED + mały bufor na CMP
              window.gtag('consent', 'default', {
                ad_storage: 'denied',
                analytics_storage: 'denied',
                ad_user_data: 'denied',
                ad_personalization: 'denied',
                wait_for_update: 500
              });

              // 3) Loader GTM z nonce (CSP)
              (function(w,d,s,l,i,nc){
                w[l]=w[l]||[];
                w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
                var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
                j.async = true;
                j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
                if (nc) j.setAttribute('nonce', nc);
                f.parentNode.insertBefore(j,f);
              })(window,document,'script','dataLayer',GTM_ID,nonce);

              // 4) Publiczne API dla banera
              window.__CONSENT_APPLIED__ = false;
              window.applyConsent = function (opts) {
                if (window.__CONSENT_APPLIED__) return;
                window.__CONSENT_APPLIED__ = true;

                var update = {
                  analytics_storage:     opts && opts.analytics          ? 'granted' : 'denied',
                  ad_storage:            opts && opts.ads                ? 'granted' : 'denied',
                  ad_user_data:          opts && opts.ad_user_data       ? 'granted' : 'denied',
                  ad_personalization:    opts && opts.ad_personalization ? 'granted' : 'denied'
                };
                window.gtag('consent', 'update', update);
              };
            })();
          </script>
        )}
        
    </head>
    <body class="bg-ghost-white text-vantablack font-sans antialiased min-h-screen relative selection:bg-signal-orange selection:text-white">
        
        {/* ===== GTM: No-Script Fallback (NA SAMYM POCZĄTKU BODY) ===== */}
        {GTM_ID && (
          <noscript>
            <iframe src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`} height="0" width="0" style="display:none;visibility:hidden"></iframe>
          </noscript>
        )}

        {/* Globalny Preloader działający tylko przy hard-reload, zachowujący stan przy przejściach Astro */}
        <Preloader client:load transition:persist="global-preloader" />

        <slot />

        {/* Baner ciasteczek ładujący się po stronie klienta (gadający z GTM) */}
        <CookieConsent client:idle />
    </body>
</html>